/*****************************************************************************
*Tree    :EventTree : EventTree                                              *
*Entries :      200 : Total =        18159597 bytes  File  Size =    8728583 *
*        :          : Tree compression factor =   2.08                       *
******************************************************************************
*Br    0 :event     : event/I                                                *
*Entries :      200 : Total  Size=       1362 bytes  File Size  =        412 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   2.13     *
*............................................................................*
*Br    1 :NTruthVtx : NTruthVtx/I                                            *
*Entries :      200 : Total  Size=       1382 bytes  File Size  =        134 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   6.57     *
*............................................................................*
*Br    2 :TruthPV_x : vector<float>                                          *
*Entries :      200 : Total  Size=       4226 bytes  File Size  =       1598 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   2.33     *
*............................................................................*
*Br    3 :TruthPV_y : vector<float>                                          *
*Entries :      200 : Total  Size=       4226 bytes  File Size  =       1617 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   2.30     *
*............................................................................*
*Br    4 :TruthPV_z : vector<float>                                          *
*Entries :      200 : Total  Size=       4226 bytes  File Size  =       1488 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   2.50     *
*............................................................................*
*Br    5 :TruthPV_Npart : vector<int>                                        *
*Entries :      200 : Total  Size=       4246 bytes  File Size  =       1191 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   3.13     *
*............................................................................*
*Br    6 :TruthPV_Nhits : vector<int>                                        *
*Entries :      200 : Total  Size=       4246 bytes  File Size  =       1151 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   3.24     *
*............................................................................*
*Br    7 :TruthPV_NClus : vector<int>                                        *
*Entries :      200 : Total  Size=       4246 bytes  File Size  =       1153 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   3.23     *
*............................................................................*
*Br    8 :TruthPV_t : vector<float>                                          *
*Entries :      200 : Total  Size=       4226 bytes  File Size  =       1619 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   2.30     *
*............................................................................*
*Br    9 :TruthPV_embed : vector<float>                                      *
*Entries :      200 : Total  Size=       4246 bytes  File Size  =        571 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   6.52     *
*............................................................................*
*Br   10 :TruthPV_trig_x : TruthPV_trig_x/F                                  *
*Entries :      200 : Total  Size=       1407 bytes  File Size  =        886 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   1.00     *
*............................................................................*
*Br   11 :TruthPV_trig_y : TruthPV_trig_y/F                                  *
*Entries :      200 : Total  Size=       1407 bytes  File Size  =        886 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   1.00     *
*............................................................................*
*Br   12 :TruthPV_trig_z : TruthPV_trig_z/F                                  *
*Entries :      200 : Total  Size=       1407 bytes  File Size  =        837 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   1.06     *
*............................................................................*
*Br   13 :TruthPV_trig_Npart : TruthPV_trig_Npart/I                          *
*Entries :      200 : Total  Size=       1427 bytes  File Size  =        642 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   1.39     *
*............................................................................*
*Br   14 :UniqueAncG4P_Px : vector<float>                                    *
*Entries :      200 : Total  Size=       3424 bytes  File Size  =        482 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   6.01     *
*............................................................................*
*Br   15 :UniqueAncG4P_Py : vector<float>                                    *
*Entries :      200 : Total  Size=       3424 bytes  File Size  =        482 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   6.01     *
*............................................................................*
*Br   16 :UniqueAncG4P_Pz : vector<float>                                    *
*Entries :      200 : Total  Size=       3424 bytes  File Size  =        482 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   6.01     *
*............................................................................*
*Br   17 :UniqueAncG4P_Pt : vector<float>                                    *
*Entries :      200 : Total  Size=     455377 bytes  File Size  =     408182 *
*Baskets :       16 : Basket Size=      32000 bytes  Compression=   1.11     *
*............................................................................*
*Br   18 :UniqueAncG4P_Eta : vector<float>                                   *
*Entries :      200 : Total  Size=     455397 bytes  File Size  =     416122 *
*Baskets :       16 : Basket Size=      32000 bytes  Compression=   1.09     *
*............................................................................*
*Br   19 :UniqueAncG4P_Phi : vector<float>                                   *
*Entries :      200 : Total  Size=     455397 bytes  File Size  =     421412 *
*Baskets :       16 : Basket Size=      32000 bytes  Compression=   1.08     *
*............................................................................*
*Br   20 :UniqueAncG4P_E : vector<float>                                     *
*Entries :      200 : Total  Size=     455357 bytes  File Size  =     409223 *
*Baskets :       16 : Basket Size=      32000 bytes  Compression=   1.11     *
*............................................................................*
*Br   21 :UniqueAncG4P_PID : vector<int>                                     *
*Entries :      200 : Total  Size=     455397 bytes  File Size  =     101747 *
*Baskets :       16 : Basket Size=      32000 bytes  Compression=   4.47     *
*............................................................................*
*Br   22 :UniqueAncG4P_TrackPID : vector<int>                                *
*Entries :      200 : Total  Size=     455497 bytes  File Size  =     267296 *
*Baskets :       16 : Basket Size=      32000 bytes  Compression=   1.70     *
*............................................................................*
*Br   23 :UniqueAncG4P_VtxPID : vector<int>                                  *
*Entries :      200 : Total  Size=     455457 bytes  File Size  =       7768 *
*Baskets :       16 : Basket Size=      32000 bytes  Compression=  58.54     *
*............................................................................*
*Br   24 :UniqueAncG4P_ParentPID : vector<int>                               *
*Entries :      200 : Total  Size=     455517 bytes  File Size  =       7382 *
*Baskets :       16 : Basket Size=      32000 bytes  Compression=  61.61     *
*............................................................................*
*Br   25 :UniqueAncG4P_PrimaryPID : vector<int>                              *
*Entries :      200 : Total  Size=     455537 bytes  File Size  =     267325 *
*Baskets :       16 : Basket Size=      32000 bytes  Compression=   1.70     *
*............................................................................*
*Br   26 :UniqueAncG4P_IonCharge : vector<double>                            *
*Entries :      200 : Total  Size=     907979 bytes  File Size  =      13117 *
*Baskets :       33 : Basket Size=      32000 bytes  Compression=  69.14     *
*............................................................................*
*Br   27 :UniqueAncG4P_TrackID : vector<int>                                 *
*Entries :      200 : Total  Size=     455477 bytes  File Size  =     208286 *
*Baskets :       16 : Basket Size=      32000 bytes  Compression=   2.18     *
*............................................................................*
*Br   28 :UniqueAncG4P_NClus : vector<int>                                   *
*Entries :      200 : Total  Size=     455437 bytes  File Size  =       7677 *
*Baskets :       16 : Basket Size=      32000 bytes  Compression=  59.24     *
*............................................................................*
*Br   29 :Layer1_occupancy : Layer1_occupancy/I                              *
*Entries :      200 : Total  Size=       1417 bytes  File Size  =        580 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   1.53     *
*............................................................................*
*Br   30 :NClus     : NClus/I                                                *
*Entries :      200 : Total  Size=       1362 bytes  File Size  =        591 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   1.48     *
*............................................................................*
*Br   31 :NTrkrhits : NTrkrhits/I                                            *
*Entries :      200 : Total  Size=       1382 bytes  File Size  =        613 *
*Baskets :        1 : Basket Size=      32000 bytes  Compression=   1.44     *
*............................................................................*
*Br   32 :TrkrHitRow : vector<unsigned short>                                *
*Entries :      200 : Total  Size=     836721 bytes  File Size  =     456722 *
*Baskets :       31 : Basket Size=      32000 bytes  Compression=   1.83     *
*............................................................................*
*Br   33 :TrkrHitColumn : vector<unsigned short>                             *
*Entries :      200 : Total  Size=     836826 bytes  File Size  =     155713 *
*Baskets :       31 : Basket Size=      32000 bytes  Compression=   5.37     *
*............................................................................*
*Br   34 :ClusLayer : vector<int>                                            *
*Entries :      200 : Total  Size=    1000498 bytes  File Size  =      16308 *
*Baskets :       37 : Basket Size=      32000 bytes  Compression=  61.28     *
*............................................................................*
*Br   35 :ClusX     : vector<float>                                          *
*Entries :      200 : Total  Size=    1000334 bytes  File Size  =     915771 *
*Baskets :       37 : Basket Size=      32000 bytes  Compression=   1.09     *
*............................................................................*
*Br   36 :ClusY     : vector<float>                                          *
*Entries :      200 : Total  Size=    1000334 bytes  File Size  =     918434 *
*Baskets :       37 : Basket Size=      32000 bytes  Compression=   1.09     *
*............................................................................*
*Br   37 :ClusZ     : vector<float>                                          *
*Entries :      200 : Total  Size=    1000334 bytes  File Size  =     781469 *
*Baskets :       37 : Basket Size=      32000 bytes  Compression=   1.28     *
*............................................................................*
*Br   38 :ClusR     : vector<float>                                          *
*Entries :      200 : Total  Size=    1000334 bytes  File Size  =     839435 *
*Baskets :       37 : Basket Size=      32000 bytes  Compression=   1.19     *
*............................................................................*
*Br   39 :ClusPhi   : vector<float>                                          *
*Entries :      200 : Total  Size=    1000416 bytes  File Size  =     925350 *
*Baskets :       37 : Basket Size=      32000 bytes  Compression=   1.08     *
*............................................................................*
*Br   40 :ClusEta   : vector<float>                                          *
*Entries :      200 : Total  Size=    1000416 bytes  File Size  =     898837 *
*Baskets :       37 : Basket Size=      32000 bytes  Compression=   1.11     *
*............................................................................*
*Br   41 :ClusAdc   : vector<unsigned int>                                   *
*Entries :      200 : Total  Size=    1000416 bytes  File Size  =      12101 *
*Baskets :       37 : Basket Size=      32000 bytes  Compression=  82.58     *
*............................................................................*
*Br   42 :ClusPhiSize : vector<float>                                        *
*Entries :      200 : Total  Size=    1000580 bytes  File Size  =     168950 *
*Baskets :       37 : Basket Size=      32000 bytes  Compression=   5.92     *
*............................................................................*
*Br   43 :ClusZSize : vector<float>                                          *
*Entries :      200 : Total  Size=    1000498 bytes  File Size  =      12993 *
*Baskets :       37 : Basket Size=      32000 bytes  Compression=  76.92     *
*............................................................................*
*Br   44 :ClusLadderZId : vector<unsigned char>                              *
*Entries :      200 : Total  Size=     252493 bytes  File Size  =      12759 *
*Baskets :        9 : Basket Size=      32000 bytes  Compression=  19.75     *
*............................................................................*
*Br   45 :ClusLadderPhiId : vector<unsigned char>                            *
*Entries :      200 : Total  Size=     252519 bytes  File Size  =      51750 *
*Baskets :        9 : Basket Size=      32000 bytes  Compression=   4.87     *
*............................................................................*
*/

#include "./headers/zFinding.h"
#include "./headers/Analysis.h"

void zExpandingAnalysis (TTree *EventTree, Int_t target, std::vector<std::string> method) {
    std::vector<float> *ClusX = nullptr;
    std::vector<float> *ClusY = nullptr;
    std::vector<float> *ClusZ = nullptr;
    std::vector<int>   *ClusLayer = nullptr;
    std::vector<float> *TruthPV_x = nullptr;
    std::vector<float> *TruthPV_y = nullptr;
    std::vector<float> *TruthPV_z = nullptr;
    std::vector<float> *TruthPV_Npart = nullptr;
    int event, NTruthVtx;
    EventTree -> SetBranchAddress("event", &event);
    EventTree -> SetBranchAddress("ClusX", &ClusX);
    EventTree -> SetBranchAddress("ClusY", &ClusY);
    EventTree -> SetBranchAddress("ClusZ", &ClusZ);
    EventTree -> SetBranchAddress("ClusLayer", &ClusLayer);
    EventTree -> SetBranchAddress("TruthPV_x", &TruthPV_x);
    EventTree -> SetBranchAddress("TruthPV_y", &TruthPV_y);
    EventTree -> SetBranchAddress("TruthPV_z", &TruthPV_z);
    EventTree -> SetBranchAddress("NTruthVtx", &NTruthVtx);
    EventTree -> SetBranchAddress("TruthPV_Npart", &TruthPV_Npart);

    std::vector<myTrackletMember> tracklet_layer_0, tracklet_layer_1;

    for (int i = 0; i < EventTree -> GetEntries(); ++i) {
        EventTree -> GetEntry(i);
        if (target == i && NTruthVtx == 1 && TruthPV_Npart->at(0) > 500) {
            for (int j = 0; j < ClusX->size(); j++) {
                if (ClusLayer->at(j) == 3 || ClusLayer->at(j) == 4) {
                    for (int k = -16; k <= 16; k++) {
                        tracklet_layer_0.push_back({ClusX->at(j), ClusY->at(j), ClusZ->at(j) + k*0.05, std::sqrt(std::pow(ClusX->at(j), 2) + std::pow(ClusY->at(j), 2)), INFINITY, std::atan2(ClusY->at(j), ClusX->at(j)), 0});
                    }
                } else {
                    for (int k = -16; k <= 16; k++) {
                        tracklet_layer_1.push_back({ClusX->at(j), ClusY->at(j), ClusZ->at(j) + k*0.05, std::sqrt(std::pow(ClusX->at(j), 2) + std::pow(ClusY->at(j), 2)), INFINITY, std::atan2(ClusY->at(j), ClusX->at(j)), 1});
                    }
                }
            }
            if (method[1] == "dPhi")   dPhiCheck(event, tracklet_layer_0, tracklet_layer_1);
            if (method[1] == "DC")     DCCheck(event, tracklet_layer_0, tracklet_layer_1);
            break;
        }
    }
            
}

void trueEtaPhiAnalysis (TTree *EventTree, Int_t target, std::vector<std::string> method, double lower_bound, double upper_bound) {
    // Set up variables to hold the data
    std::vector<float> *ClusX = nullptr;
    std::vector<float> *ClusY = nullptr;
    std::vector<float> *ClusZ = nullptr;
    std::vector<int>   *ClusLayer = nullptr;
    std::vector<int>   *ClusLadderPhiId = nullptr;
    std::vector<int>   *UniqueAncG4P_TrackID = nullptr;
    std::vector<float> *TruthPV_x = nullptr;
    std::vector<float> *TruthPV_y = nullptr;
    std::vector<float> *TruthPV_z = nullptr;
    std::vector<float> *TruthPV_Npart = nullptr;
    int event, NTruthVtx;
    float centrality_mbd;
    EventTree -> SetBranchAddress("event", &event);
    EventTree -> SetBranchAddress("ClusX", &ClusX);
    EventTree -> SetBranchAddress("ClusY", &ClusY);
    EventTree -> SetBranchAddress("ClusZ", &ClusZ);
    EventTree -> SetBranchAddress("ClusLayer", &ClusLayer);
    EventTree -> SetBranchAddress("ClusLadderPhiId", &ClusLadderPhiId);
    EventTree -> SetBranchAddress("UniqueAncG4P_TrackID", &UniqueAncG4P_TrackID);
    EventTree -> SetBranchAddress("TruthPV_x", &TruthPV_x);
    EventTree -> SetBranchAddress("TruthPV_y", &TruthPV_y);
    EventTree -> SetBranchAddress("TruthPV_z", &TruthPV_z);
    EventTree -> SetBranchAddress("NTruthVtx", &NTruthVtx);
    EventTree -> SetBranchAddress("TruthPV_Npart", &TruthPV_Npart);
    EventTree -> SetBranchAddress("centrality_mbd", &centrality_mbd);

    std::vector<myTrackletMember> tracklet_layer_0, tracklet_layer_1;

    if (method[1] == "single") {
    for (int i = 0; i < EventTree -> GetEntries(); ++i) {
        EventTree -> GetEntry(i);
        if (i == target && NTruthVtx == 1 && TruthPV_Npart->at(0) > 500
            && centrality_mbd <= 70 && TruthPV_z->at(0) >= -25. && TruthPV_z->at(0) <= -15.) {
            std::cout << ClusX->size() << "," << UniqueAncG4P_TrackID->size() << std::endl;
            for (int j = 0; j < ClusX->size(); j++) {
                double z = ClusZ->at(j) - TruthPV_z->at(0);
                double r = std::sqrt(std::pow(ClusX->at(j), 2) + std::pow(ClusY->at(j), 2));
                double theta = std::atan2(r, z);
                double eta;
                if (z >= 0) {
                    eta = -std::log(std::tan(theta/2));
                } else {
                    eta = std::log(std::tan((M_PI - theta)/2));
                }
                if (ClusLayer->at(j) == 3 || ClusLayer->at(j) == 4) {
                    tracklet_layer_0.push_back({ClusX->at(j), ClusY->at(j), ClusZ->at(j), r, eta, std::atan2(ClusY->at(j), ClusX->at(j)), 0});
                } else {
                    tracklet_layer_1.push_back({ClusX->at(j), ClusY->at(j), ClusZ->at(j), r, eta, std::atan2(ClusY->at(j), ClusX->at(j)), 1});
                }
            }
            if (method[2] == "phi") {
                PhiCheck(event, tracklet_layer_0, tracklet_layer_1, -0.001, 0.001, lower_bound, upper_bound, TruthPV_z->at(0));
                break;
            } else if (method[2] == "dphi") {
                dPhiCheck(event, tracklet_layer_0, tracklet_layer_1);
                break;
            } else if (method[2] == "deta"){
                dEtaCheck(event, tracklet_layer_0, tracklet_layer_1, -0.001, 0.001, lower_bound, upper_bound, TruthPV_z->at(0));
                break;
            } else {
                EtaCheck(event, tracklet_layer_0, tracklet_layer_1, -0.001, 0.001, lower_bound, upper_bound, TruthPV_z->at(0));
                break;
            }
        }
    }
    } else if (method[1] != "single") {
        TH1D *h_deta = new TH1D("", "", 80, -4 - .05, 4 + .05);
        TH1D *h_dphi = new TH1D("", "", 140, -7 - .05, 7 + .05);
        for (int i = 0; i < EventTree -> GetEntries(); ++i) {
            EventTree -> GetEntry(i);
            if (i >= target && NTruthVtx == 1 && TruthPV_Npart->at(0) > 500
                && centrality_mbd <= 10 && TruthPV_z->at(0) >= -25. && TruthPV_z->at(0) <= -15.) {
                for (int j = 0; j < ClusX->size(); j++) {
                    double z = ClusZ->at(j) - TruthPV_z->at(0);
                    double r = std::sqrt(std::pow(ClusX->at(j), 2) + std::pow(ClusY->at(j), 2));
                    double theta = std::atan2(r, z);
                    double eta;
                    if (z >= 0) {
                        eta = -std::log(std::tan(theta/2));
                    } else {
                        eta = std::log(std::tan((M_PI - theta)/2));
                    }
                    if (ClusLayer->at(j) == 3 || ClusLayer->at(j) == 4) {
                        tracklet_layer_0.push_back({ClusX->at(j), ClusY->at(j), ClusZ->at(j), r, eta, std::atan2(ClusY->at(j), ClusX->at(j)), 0});
                    } else {
                        tracklet_layer_1.push_back({ClusX->at(j), ClusY->at(j), ClusZ->at(j), r, eta, std::atan2(ClusY->at(j), ClusX->at(j)), 1});
                    }
                }
                for (int i = 0; i < tracklet_layer_0.size(); i++) {
                    for (int j = 0; j < tracklet_layer_1.size(); j++) {
                        h_dphi -> Fill(tracklet_layer_0[i].phi - tracklet_layer_1[j].phi);
                        h_deta -> Fill(tracklet_layer_0[i].eta - tracklet_layer_1[j].eta);
                    }
                }
                tracklet_layer_0.clear();   tracklet_layer_1.clear();
            }
        }
        TCanvas *can1 = new TCanvas("c1","c1",0,50,1800,550);
        if (method[2] == "dphi") {
        h_dphi -> Draw();
        h_dphi -> SetFillColor(kYellow - 7);
        h_dphi -> SetLineWidth(1);
        h_dphi -> SetFillStyle(1001);
        h_dphi -> GetXaxis() -> SetTitle("Phi value");
        h_dphi -> GetXaxis() -> SetTitleSize(.05);
        h_dphi -> GetXaxis() -> SetLabelSize(.04);
        h_dphi -> GetXaxis() -> CenterTitle(true);
        h_dphi -> GetXaxis() -> SetNdivisions(31, 5, 0);
        h_dphi -> GetXaxis() -> SetTitleOffset(.8);
        h_dphi -> GetYaxis() -> SetTitle("# of Counts");
        h_dphi -> GetYaxis() -> SetTitleSize(.05);
        h_dphi -> GetYaxis() -> SetLabelSize(.04);
        h_dphi -> GetYaxis() -> SetTitleOffset(.62);
        h_dphi -> GetYaxis() -> CenterTitle(true);
        h_dphi -> SetTitle("dPhi data of all Event");
        gPad -> SetLogy();
        can1 -> SaveAs("zFindingPlots/dPhi_all.png");
        } else {
            h_deta -> Draw();
        h_deta -> SetFillColor(kYellow - 7);
        h_deta -> SetLineWidth(1);
        h_deta -> SetFillStyle(1001);
        h_deta -> GetXaxis() -> SetTitle("Eta value");
        h_deta -> GetXaxis() -> SetTitleSize(.05);
        h_deta -> GetXaxis() -> SetLabelSize(.04);
        h_deta -> GetXaxis() -> CenterTitle(true);
        h_deta -> GetXaxis() -> SetNdivisions(31, 5, 0);
        h_deta -> GetXaxis() -> SetTitleOffset(.8);
        h_deta -> GetYaxis() -> SetTitle("# of Counts");
        h_deta -> GetYaxis() -> SetTitleSize(.05);
        h_deta -> GetYaxis() -> SetLabelSize(.04);
        h_deta -> GetYaxis() -> SetTitleOffset(.62);
        h_deta -> GetYaxis() -> CenterTitle(true);
        h_deta -> SetTitle("dEta data of all Event");
        gPad -> SetLogy();
        can1 -> SaveAs("zFindingPlots/dEta_all.png");
        }
    }
    else if (method[2] == "dEtaPhi") {
        TH2D *h_eta_phi = new TH2D("", "", 80, -4 - .05, 4 + .05, 70, -3.5 - .05, 3.5 + .05);
        for (int i = 0; i < EventTree -> GetEntries(); ++i) {
            EventTree -> GetEntry(i);
            if (NTruthVtx == 1 && TruthPV_Npart->at(0) > 500) {
                for (int j = 0; j < ClusX->size(); j++) {
                    double z = ClusZ->at(j) - TruthPV_z->at(0);
                    double r = std::sqrt(std::pow(ClusX->at(j), 2) + std::pow(ClusY->at(j), 2));
                    double theta = std::atan2(r, z);
                    double eta;
                    if (z >= 0) {
                        eta = -std::log(std::tan(theta/2));
                    } else {
                        eta = std::log(std::tan((M_PI - theta)/2));
                    }
                    if (ClusLayer->at(j) == 3 || ClusLayer->at(j) == 4) {
                        tracklet_layer_0.push_back({ClusX->at(j), ClusY->at(j), ClusZ->at(j), r, eta, std::atan2(ClusY->at(j), ClusX->at(j)), 0});
                    } else {
                        tracklet_layer_1.push_back({ClusX->at(j), ClusY->at(j), ClusZ->at(j), r, eta, std::atan2(ClusY->at(j), ClusX->at(j)), 1});
                    }
                }
                for (int i = 0; i < tracklet_layer_0.size(); i++) {
                    for (int j = 0; j < tracklet_layer_1.size(); j++) {
                        h_eta_phi -> Fill(tracklet_layer_0[i].eta - tracklet_layer_1[j].eta, tracklet_layer_0[i].phi - tracklet_layer_1[j].phi);
                        // h_dphi -> Fill(tracklet_layer_0[i].phi - tracklet_layer_1[j].phi);
                    }
                }
                tracklet_layer_0.clear();   tracklet_layer_1.clear();
            }
        }
        TCanvas *can1 = new TCanvas("c1","c1",0,50,1800,550);
        h_eta_phi -> Draw("COLZ");
        h_eta_phi -> GetXaxis() -> SetTitle("Delta Eta");
        h_eta_phi -> GetYaxis() -> SetTitle("Delta Phi");
        h_eta_phi -> SetTitle("dEtaPhi checking of all events");
        TLine *l1 = new TLine(-4, 0, 4, 0);
        l1 -> SetLineColor(kRed - 7);
        l1 -> SetLineWidth(2);
        l1 -> Draw("same");
        TLine *l2 = new TLine(0, -4, 0, 4);
        l2 -> SetLineColor(kRed - 7);
        l2 -> SetLineWidth(2);
        l2 -> Draw("same");
        can1 -> SaveAs("zFindingPlots/dEtaPhiAll.png");
    }
}

void single_z_finding (TTree *EventTree, Int_t target, std::vector<std::string> method, double lower_bound, double upper_bound) {
    // Set up variables to hold the data
    std::vector<float> *ClusX = nullptr;
    std::vector<float> *ClusY = nullptr;
    std::vector<float> *ClusZ = nullptr;
    std::vector<int>   *ClusLayer = nullptr;
    std::vector<int>   *ClusLadderPhiId = nullptr;
    std::vector<float> *TruthPV_x = nullptr;
    std::vector<float> *TruthPV_y = nullptr;
    std::vector<float> *TruthPV_z = nullptr;
    std::vector<float> *TruthPV_Npart = nullptr;
    int event, NTruthVtx;
    float centrality_mbd;
    EventTree -> SetBranchAddress("event", &event);
    EventTree -> SetBranchAddress("ClusX", &ClusX);
    EventTree -> SetBranchAddress("ClusY", &ClusY);
    EventTree -> SetBranchAddress("ClusZ", &ClusZ);
    EventTree -> SetBranchAddress("ClusLayer", &ClusLayer);
    EventTree -> SetBranchAddress("ClusLadderPhiId", &ClusLadderPhiId);
    EventTree -> SetBranchAddress("TruthPV_x", &TruthPV_x);
    EventTree -> SetBranchAddress("TruthPV_y", &TruthPV_y);
    EventTree -> SetBranchAddress("TruthPV_z", &TruthPV_z);
    EventTree -> SetBranchAddress("NTruthVtx", &NTruthVtx);
    EventTree -> SetBranchAddress("TruthPV_Npart", &TruthPV_Npart);
    EventTree -> SetBranchAddress("centrality_mbd", &centrality_mbd);

    std::vector<myTrackletMemberExtended> tracklet_layer_0, tracklet_layer_1;
    double found_z;

    for (int i = 0; i < EventTree -> GetEntries(); ++i) {
        EventTree -> GetEntry(i);
        if (target == i && NTruthVtx == 1 && TruthPV_Npart->at(0) > 500
            && centrality_mbd <= 70 && TruthPV_z->at(0) >= -25. && TruthPV_z->at(0) <= -15.) {
            for (int j = 0; j < ClusX->size(); j++) {
                if (ClusLayer->at(j) == 3 || ClusLayer->at(j) == 4) {
                    for (int k = 0; k <= 32; k++) {
                        tracklet_layer_0.push_back({ClusX->at(j), ClusY->at(j), ClusZ->at(j) + k*0.05, std::sqrt(std::pow(ClusX->at(j), 2) + std::pow(ClusY->at(j), 2)), INFINITY, std::atan2(ClusY->at(j), ClusX->at(j)), 0});
                    }
                } else {
                    for (int k = 0; k <= 32; k++) {
                        tracklet_layer_1.push_back({ClusX->at(j), ClusY->at(j), ClusZ->at(j) + k*0.05, std::sqrt(std::pow(ClusX->at(j), 2) + std::pow(ClusY->at(j), 2)), INFINITY, std::atan2(ClusY->at(j), ClusX->at(j)), 1});
                    }
                }
            }
            if (method[1] == "e") {
                found_z = nearest_z_with_error(event, tracklet_layer_0, tracklet_layer_1, -0.001, 0.001, lower_bound, upper_bound, TruthPV_z->at(0));
            } else if (method[1] == "zscan") {
                if (TruthPV_Npart->at(0) < 2000) {
                    found_z = zScan(event, tracklet_layer_0, tracklet_layer_1, -0.001, 0.001, lower_bound, upper_bound, TruthPV_z->at(0));
                } else {
                    found_z = zScan(event, tracklet_layer_0, tracklet_layer_1, -0.0001, 0.0001, lower_bound, upper_bound, TruthPV_z->at(0));
                }
            }
            else if (method[1] == "zscanE") {
                if (TruthPV_Npart->at(0) < 2000) {
                    found_z = zScan_with_error(event, tracklet_layer_0, tracklet_layer_1, -0.01, 0.01, lower_bound, upper_bound, TruthPV_z->at(0));
                } else {
                    found_z = zScan_with_error(event, tracklet_layer_0, tracklet_layer_1, -0.001, 0.001, lower_bound, upper_bound, TruthPV_z->at(0));
                }
            }
            else if (method[1] == "zscanN") {
                if (TruthPV_Npart->at(0) < 2000) {
                    found_z = zScan_norm(event, tracklet_layer_0, tracklet_layer_1, -0.01, 0.01, lower_bound, upper_bound, TruthPV_z->at(0));
                } else {
                    found_z = zScan_norm(event, tracklet_layer_0, tracklet_layer_1, -0.001, 0.001, lower_bound, upper_bound, TruthPV_z->at(0));
                }
            }
            else if (method[1] == "DCAfit") {
                if (TruthPV_Npart->at(0) < 2000) {
                    found_z = DCA_npeaks(event, tracklet_layer_0, tracklet_layer_1, -0.01, 0.01, lower_bound, upper_bound, TruthPV_z->at(0));
                } else {
                    found_z = DCA_npeaks(event, tracklet_layer_0, tracklet_layer_1, -0.001, 0.001, lower_bound, upper_bound, TruthPV_z->at(0));
                }
            }
            else {
                found_z = nearest_z_method(event, tracklet_layer_0, tracklet_layer_1, -0.001, 0.001, lower_bound, upper_bound, TruthPV_z->at(0));
            }
            break;
        }

    }
}

void all_z_finding (TTree *EventTree, Int_t target, std::vector<std::string> method, double lower_bound, double upper_bound, const std::string &filePath) {
    std::ofstream outputFile(filePath, std::ios_base::app);
    if (!outputFile.is_open()) {
		std::cout << "Unable to open the file to be written." << std::endl;
		system("read -n 1 -s -p \"Press any key to continue...\" echo");
		exit(1);
	}

    std::ifstream checkFile(filePath, std::ios::ate); // Check if the text file is empty;
    if (!checkFile.is_open()) {
        std::cerr << "Failed to open file for reading.\n";
        system("read -n 1 -s -p \"Press any key to continue...\" echo");
        exit(1);
    }
    bool isEmpty = (checkFile.tellg() == 0);
    if(isEmpty) outputFile << "MBD: 0-10. Phi cut: " << lower_bound << " ~ " << upper_bound << ", DCA cut: " << DCA_cut << ", bin width: " << scanstep << std::endl;
    
    // Set up variables to hold the data
    std::vector<float> *ClusX = nullptr;
    std::vector<float> *ClusY = nullptr;
    std::vector<float> *ClusZ = nullptr;
    std::vector<int>   *ClusLayer = nullptr;
    std::vector<int>   *ClusLadderPhiId = nullptr;
    std::vector<float> *TruthPV_x = nullptr;
    std::vector<float> *TruthPV_y = nullptr;
    std::vector<float> *TruthPV_z = nullptr;
    std::vector<int>   *TruthPV_Npart = nullptr;
    int event, NTruthVtx;
    float centrality_bimp, centrality_impactparam, centrality_mbdquantity, centrality_mbd;
    EventTree -> SetBranchAddress("event", &event);
    EventTree -> SetBranchAddress("ClusX", &ClusX);
    EventTree -> SetBranchAddress("ClusY", &ClusY);
    EventTree -> SetBranchAddress("ClusZ", &ClusZ);
    EventTree -> SetBranchAddress("ClusLayer", &ClusLayer);
    EventTree -> SetBranchAddress("ClusLadderPhiId", &ClusLadderPhiId);
    EventTree -> SetBranchAddress("TruthPV_x", &TruthPV_x);
    EventTree -> SetBranchAddress("TruthPV_y", &TruthPV_y);
    EventTree -> SetBranchAddress("TruthPV_z", &TruthPV_z);
    EventTree -> SetBranchAddress("NTruthVtx", &NTruthVtx);
    EventTree -> SetBranchAddress("TruthPV_Npart", &TruthPV_Npart);
    EventTree -> SetBranchAddress("centrality_bimp", &centrality_bimp);
    EventTree -> SetBranchAddress("centrality_impactparam", &centrality_impactparam);
    EventTree -> SetBranchAddress("centrality_mbdquantity", &centrality_mbdquantity);
    EventTree -> SetBranchAddress("centrality_mbd", &centrality_mbd);

    // std::vector<double> xLocal, yLocal, zLocal, rLocal;
    // std::vector<double> phi, phi_0, phi_1;
    // std::vector<int> hitLayer;
    // std::vector<double> Eta, Phi, dEta, dPhi;
    std::vector<myTrackletMemberExtended> tracklet_layer_0, tracklet_layer_1;
    double found_z;

    for (int i = 0; i < EventTree -> GetEntries(); ++i) {
        EventTree -> GetEntry(i);
        // Suggested fiducial cuts: centrality 0 - 70% and vtx_z (reconstructed) -25cm to -15cm
        if (i >= target && NTruthVtx == 1 && TruthPV_Npart->at(0) > 500
            && centrality_mbd <= 10 && TruthPV_z->at(0) >= -25. && TruthPV_z->at(0) <= -15.) {
            for (int j = 0; j < ClusX->size(); j++) {
                if (ClusLayer->at(j) == 3 || ClusLayer->at(j) == 4) {
                    for (int k = 0; k <= 32; k++) {
                        tracklet_layer_0.push_back({ClusX->at(j), ClusY->at(j), ClusZ->at(j) + k*0.05, std::sqrt(std::pow(ClusX->at(j), 2) + std::pow(ClusY->at(j), 2)), INFINITY, std::atan2(ClusY->at(j), ClusX->at(j)), 0, 0});
                    }
                } else {
                    for (int k = 0; k <= 32; k++) {
                        tracklet_layer_1.push_back({ClusX->at(j), ClusY->at(j), ClusZ->at(j) + k*0.05, std::sqrt(std::pow(ClusX->at(j), 2) + std::pow(ClusY->at(j), 2)), INFINITY, std::atan2(ClusY->at(j), ClusX->at(j)), 1, 0});
                    }
                }
            }
            if (method[1] == "e") {
                found_z = nearest_z_with_error(event, tracklet_layer_0, tracklet_layer_1, -0.01, 0.01, lower_bound, upper_bound, TruthPV_z->at(0));
            } else if (method[1] == "zscan") {
                if (TruthPV_Npart->at(0) < 2000) {
                    found_z = zScan(event, tracklet_layer_0, tracklet_layer_1, -0.01, 0.01, lower_bound, upper_bound, TruthPV_z->at(0));
                } else {
                    found_z = zScan(event, tracklet_layer_0, tracklet_layer_1, -0.001, 0.001, lower_bound, upper_bound, TruthPV_z->at(0));
                }
            }
            else if (method[1] == "zscanE") {
                if (TruthPV_Npart->at(0) < 2000) {
                    found_z = zScan_with_error(event, tracklet_layer_0, tracklet_layer_1, -0.01, 0.01, lower_bound, upper_bound, TruthPV_z->at(0));
                } else {
                    found_z = zScan_with_error(event, tracklet_layer_0, tracklet_layer_1, -0.001, 0.001, lower_bound, upper_bound, TruthPV_z->at(0));
                }
            }
            else if (method[1] == "zscanN") {
                if (TruthPV_Npart->at(0) < 2000) {
                    found_z = zScan_norm(event, tracklet_layer_0, tracklet_layer_1, -0.01, 0.01, lower_bound, upper_bound, TruthPV_z->at(0));
                } else {
                    found_z = zScan_norm(event, tracklet_layer_0, tracklet_layer_1, -0.001, 0.001, lower_bound, upper_bound, TruthPV_z->at(0));
                }
            }
            else if (method[1] == "DCAfit") {
                found_z = DCA_npeaks(event, tracklet_layer_0, tracklet_layer_1, -0.01, 0.01, lower_bound, upper_bound, TruthPV_z->at(0));
            }
            else {
                found_z = nearest_z_method(event, tracklet_layer_0, tracklet_layer_1, -0.01, 0.01, lower_bound, upper_bound, TruthPV_z->at(0));
            }
            
            outputFile << event << "," << i << "," << TruthPV_Npart->at(0) << "," << std::fixed << std::setprecision(6) << found_z << std::defaultfloat << "," << TruthPV_x->at(0) << "," << TruthPV_y->at(0) << "," << TruthPV_z->at(0) << "," 
                       << centrality_bimp << "," << centrality_impactparam << "," << centrality_mbdquantity << "," << centrality_mbd << std::endl;

            tracklet_layer_0.clear();   tracklet_layer_1.clear();
        }
    }
    // foundZAnalysis(filePath, method[1], method[2]);
}

void InttZFinding_debug_ver_3 (std::string method = "single", double lower_bound = -0.1, double upper_bound = 0.1, Int_t target = 0) {
    // std::string filePath = "foundZ_debug2_nearest_z.txt";
    // std::string filePath = "foundZ_debug2_nearest_z_no_fit.txt";
    // std::string filePath = "foundZ_debug2_DCA_biased.txt";
    // std::string filePath = "foundZ_debug2_DCA_doubled.txt";
    // std::string filePath = "foundZ_debug2_DCA_-16_16_-015_015.txt";
    // std::string filePath = "foundZ_debug2_DCA_-8_8_-010_010_2e-3.txt";
    // std::string filePath = "foundZ_debug2_DCA_-8_8_-010_010_2e-1.txt";
    // std::string filePath = "foundZ_debug2_DCA_-8_8_000_010_2e-1.txt";
    // std::string filePath = "foundZ_debug2_DCA_-8_8_-010_000_1e-1.txt";
    // std::string filePath = "foundZ_allInfo_DCA_-8_8_-010_010_2e-1.txt";
    // std::string filePath = "./zFindingResults/foundZ_allInfo_DCA_0_16_-001_001_2e-1.txt";
    // std::string filePath = "./zFindingResults/foundZ_MBD0_10_DCA_0_16_-001_001_2e-1.txt";
    std::string filePath = "./zFindingResults/foundZ_MBD0_10_DCAfit_0_16_-001_001_2e-1.txt";

    // Open the ROOT file
    TFile *f = TFile::Open("../External/INTTRecoClusters_sim_ana382_zvtx-20cm_Bfield0T.root");
    if (!f || f->IsZombie()) {
        std::cerr << "Error opening file" << std::endl;
        return;
    }
    // Get the tree
    TTree *EventTree;
    f->GetObject("EventTree", EventTree);
    if (!EventTree) {
        std::cerr << "Tree not found" << std::endl;
        return;
    }

    std::vector<std::string> substrings = splitString(method, '_');
    if (substrings.size() == 2) {
        substrings.push_back("");
    }
    else if (substrings.size() == 1) {
        substrings.push_back("");
        substrings.push_back("");
    }

    if (substrings[0] == "single") {
        single_z_finding(EventTree, target, substrings, lower_bound, upper_bound);
    } else if (substrings[0] == "all") {
        all_z_finding(EventTree, target, substrings, lower_bound, upper_bound, filePath);
    } else if (substrings[0] == "anal") {
        foundZAnalysis(filePath, substrings[1], substrings[2]);
    } else if (substrings[0] == "zXpan") {
        zExpandingAnalysis(EventTree, target, substrings);
    }
    else {
        trueEtaPhiAnalysis(EventTree, target, substrings, lower_bound, upper_bound);
    }

}